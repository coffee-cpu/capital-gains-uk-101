name: Claude Code Review

on:
  pull_request_target:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 1
          persist-credentials: false

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            Review this PR with the following focus areas specific to this Capital Gains Tax Visualiser project:

            ## HMRC Compliance (Critical for tax-related changes)

            For changes in `src/lib/cgt/`, `src/lib/enrichment.ts`, `src/utils/taxYear.ts`, or tax calculation components:
            - Verify calculation logic aligns with HMRC guidance
            - Cross-reference with: TCGA92/S105(1) (same-day), TCGA92/S106A(5) (30-day), TCGA92/S104 (Section 104), TCGA92/S127 (share reorganisations)
            - Check UK tax year boundaries (April 6 - April 5) are handled correctly
            - Ensure user-facing explanations include HMRC references (CG51560, CG51620, CG51127)

            ## Code Quality

            - TypeScript strict mode compliance
            - No unused variables or imports
            - Clean separation between `GenericTransaction` (raw data) and `EnrichedTransaction` (computed fields)
            - Test coverage for new logic

            ## Privacy & Security

            - No external data transmission (all processing must be client-side)
            - Original transaction data must remain unmodified
            - Users should see both original and calculated values for transparency

            Provide detailed feedback using inline comments for specific issues.
            Use top-level comments for general observations.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"

