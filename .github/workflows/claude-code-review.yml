name: Claude Code Review

on:
  pull_request_target:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          track_progress: true
          prompt: |
            Review this PR for the Capital Gains Tax Visualiser project. Focus on finding real bugs, correctness issues, and security problems. Be concise and actionable.

            ## Review principles

            - **Only flag things that matter.** A bug in CGT calculation is critical. A label wording preference is not worth commenting on.
            - **Don't pad reviews with praise.** Skip "good design" and "nice work" inline comments — they add noise. If the code is fine, say so briefly in the summary.
            - **Severity must be proportionate.** Reserve "critical/must-fix" for: incorrect tax calculations, data loss, security vulnerabilities. Everything else is at most a suggestion.
            - **Be concrete.** If you suggest a change, show the code. If you flag a risk, describe the specific scenario where it breaks.
            - **Don't bikeshed.** Skip label wording, variable naming style, and subjective UX preferences unless they cause actual confusion.

            ## What to check

            ### 1. Correctness (highest priority)
            - CGT calculation logic: same-day rule (TCGA92/S105(1)), 30-day bed-and-breakfast (TCGA92/S106A(5)), Section 104 pooling (TCGA92/S104), share reorganisations (TCGA92/S127)
            - UK tax year boundaries (April 6 – April 5)
            - Data integrity: `GenericTransaction` (raw) vs `EnrichedTransaction` (computed) separation
            - Edge cases: division by zero, NaN propagation, off-by-one in date logic

            ### 2. Bugs and robustness
            - Unbounded loops or requests (e.g. a bad date causing thousands of API calls)
            - Missing error handling where failures would silently corrupt results
            - Race conditions in async code

            ### 3. Security
            - User transaction data must never be sent to external services. (Note: fetching *public reference data* like FX rates or stock split records from external APIs is fine — that's not user data.)
            - No XSS, injection, or prototype pollution vectors
            - Secrets/credentials not hardcoded

            ### 4. Test coverage
            - New logic paths should have tests. Flag if they don't, but don't demand tests for trivial wiring.

            ## Output format

            Write a single top-level summary comment. Only add inline comments for specific code locations where you have a concrete, actionable suggestion or bug report. Aim for fewer, higher-quality comments rather than comprehensive coverage of every file.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"

